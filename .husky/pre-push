#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push checks - more comprehensive than pre-commit
echo "ğŸš€ Running pre-push checks..."

# 1. Full test suite
echo "\nğŸ§ª Running full test suite..."
npm test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed! Fix all tests before pushing."
  exit 1
fi

# 2. Health check
echo "\nğŸ’Š Running health check..."
npm run health-check
if [ $? -ne 0 ]; then
  echo "âŒ Health check failed! System not ready to push."
  exit 1
fi

# 3. Security audit (only high/critical)
echo "\nğŸ”’ Running security audit..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo "âš ï¸  Security vulnerabilities found!"
  echo "Review and fix high/critical vulnerabilities before pushing."
  echo "Run: npm audit fix"
  exit 1
fi

# 4. Check for console.log (warning only, don't fail)
echo "\nğŸ” Checking for console.log statements..."
console_logs=$(git diff --cached --name-only | grep '\.ts$' | xargs grep -n 'console\.log' 2>/dev/null || true)
if [ -n "$console_logs" ]; then
  echo "âš ï¸  Warning: Found console.log statements:"
  echo "$console_logs"
  echo "Consider using proper logging or removing debug statements."
fi

echo "\nâœ… All pre-push checks passed!"
echo "ğŸš€ Safe to push.\n"
